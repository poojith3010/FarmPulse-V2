<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Prediction - FarmPulse Pro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="/static/js/app.js"></script>

  <style>
    :root {
        --primary: #10b981; 
        --glass-bg: rgba(5, 10, 8, 0.75);
        --glass-border: rgba(255, 255, 255, 0.06);
        --glass-highlight: rgba(255, 255, 255, 0.04);
    }

    body {
        margin: 0;
        background-color: #050505;
        color: #ecfdf5;
        font-family: 'Space Grotesk', sans-serif;
        overflow-x: hidden;
        padding-bottom: 100px;
    }

    /* --- 3D Background --- */
    #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -2; }
    
    .ambient-glow {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 80vw; height: 80vh;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
        z-index: -1; pointer-events: none;
    }

    .grid-overlay {
        position: fixed; inset: 0;
        background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
        background-size: 30px 30px; pointer-events: none; z-index: -1;
    }

    /* --- Glass Panel --- */
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border-top: 1px solid var(--glass-highlight);
        position: relative;
        overflow: hidden; 
        transition: all 0.3s ease;
    }

    /* --- HIDE SCROLLBAR UTILITY --- */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    /* --- Expansion Logic --- */
    .details-content { 
        max-height: 0; overflow: hidden; 
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
        opacity: 0;
        background: rgba(0,0,0,0.3);
    }
    .details-content.open { max-height: 500px; opacity: 1; }
    .rotate-icon { transition: transform 0.3s ease; }
    .open .rotate-icon { transform: rotate(180deg); color: var(--primary); }

    /* --- Nav --- */
    .nav-link.active { color: var(--primary); }
    .nav-link.active .icon-box { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); color: var(--primary); }
    
    /* FIX: Make Date/Number inputs white in Dark Mode */
    input[type="date"], input[type="number"] {
        color-scheme: dark; /* Forces browser calendar icon to be white */
        color: #ffffff;     /* Forces text to be white */
        background-color: rgba(0, 0, 0, 0.3); /* Ensure contrast */
    }
  
  </style>
</head>
<body class="antialiased selection:bg-emerald-500 selection:text-black">

  <div id="canvas-container"></div>
  <div class="ambient-glow"></div>
  <div class="grid-overlay"></div>

  <div class="max-w-7xl mx-auto px-4 md:px-8 pt-8">

    <div class="flex justify-between items-end mb-8 gap-4 fade-in">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <div class="w-2 h-8 bg-emerald-500 rounded-full shadow-[0_0_15px_#10b981]"></div>
                <h1 class="text-4xl font-bold tracking-tight">Projections</h1>
            </div>
            <p class="text-gray-400 text-sm font-light ml-4">AI Weather Modeling</p>
        </div>
    </div>

    <main id="predictionPage" class="space-y-8">

      <div class="fade-in">
        <div class="flex justify-between items-end mb-3 px-1">
            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Seasonal Yield Forecaster</h2>
            <div class="flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span class="text-xs text-emerald-500 font-mono">AI MODEL V2</span>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-6 md:p-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-1">Harvest Projection</h3>
                        <p class="text-xs text-gray-400 font-mono">Based on 10-year historical seasonal data</p>
                    </div>

                    <div class="space-y-4">
                        <div class="group">
                            <label class="block text-xs text-gray-500 uppercase font-bold tracking-wider mb-2">Target Date</label>
                            <input type="date" id="forecastDate" 
                                class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:border-emerald-500/50 focus:ring-1 focus:ring-emerald-500/50 transition-all font-mono">
                        </div>

                        <div class="group">
                            <label class="block text-xs text-gray-500 uppercase font-bold tracking-wider mb-2">Farm Size (Acres)</label>
                            <input type="number" id="farmSize" value="4" step="0.5" 
                                class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:border-emerald-500/50 focus:ring-1 focus:ring-emerald-500/50 transition-all font-mono">
                        </div>
                    </div>

                    <button onclick="getSeasonalForecast()" 
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/20 transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2">
                        <span class="material-icons text-sm">psychology</span>
                        RUN PREDICTION
                    </button>
                </div>

                <div class="bg-black/20 rounded-xl border border-white/5 p-6 flex flex-col justify-between relative">
                    
                    <div class="absolute top-4 right-4 text-xs font-mono text-gray-600" id="yield-meta">IDLE</div>

                    <div>
                        <span class="text-xs text-emerald-400 font-bold uppercase tracking-widest border border-emerald-500/20 px-2 py-1 rounded">Estimated Output</span>
                        <div class="mt-4 flex items-baseline gap-2">
                            <h1 id="yieldOutput" class="text-5xl md:text-6xl font-bold text-white tracking-tighter">--</h1>
                            <span class="text-xl text-gray-500">KG</span>
                        </div>
                        <p id="yieldPerAcre" class="text-sm text-gray-400 mt-1 font-mono">-- KG/Acre</p>
                    </div>

                    <div class="mt-6 pt-6 border-t border-white/5">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-500/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-icons text-emerald-500 text-sm">smart_toy</span>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-300 uppercase mb-1">AI Analysis</h4>
                                <p id="aiExplanation" class="text-sm text-gray-400 leading-relaxed">
                                    Select a date and farm size to generate a report.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
      
      <div class="fade-in">
        <div class="flex justify-between items-end mb-3 px-1">
            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Hourly Analysis</h2>
            <span class="text-xs text-emerald-500 font-mono border border-emerald-500/30 px-2 py-1 rounded">T+24 HOURS</span>
        </div>
        
        <div class="glass-panel rounded-2xl p-4 w-full relative group" data-tilt data-tilt-max="1" data-tilt-speed="1000" data-tilt-glare data-tilt-max-glare="0.05">
          <div class="overflow-x-auto no-scrollbar">
             <div id="chartContainer" class="h-80" style="min-width: 1200px;"> 
                <canvas id="hourlyChart"></canvas>
             </div>
          </div>
        </div>
      </div>
      
      <div class="fade-in" style="animation-delay: 0.2s;">
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">Long Range Forecast</h2>
        <div id="dailyForecastList" class="space-y-3">
            </div>
      </div>

    </main>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 glass-panel border-t border-white/5 h-20 z-50 rounded-t-2xl md:rounded-none backdrop-blur-xl">
    <div class="flex justify-center items-center h-full gap-8 md:gap-16">
        
        <a href="/dashboard" class="nav-link flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors cursor-pointer">
            <span class="material-icons text-xl">dashboard</span><span class="text-[10px] font-bold uppercase">Dash</span>
        </a>

        <a href="/prediction" class="nav-link active flex flex-col items-center gap-1 group cursor-pointer">
            <div class="icon-box w-10 h-8 rounded-lg border border-transparent flex items-center justify-center transition-all">
                <span class="material-icons text-xl">show_chart</span>
            </div>
            <span class="text-[10px] font-bold uppercase tracking-wide">Predict</span>
        </a>

        <a href="/static/research.html" class="nav-link flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors cursor-pointer">
            <span class="material-icons text-xl">menu_book</span><span class="text-[10px] font-bold uppercase">Research</span>
        </a>
        <a href="/static/doctor.html" class="nav-link flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors cursor-pointer">
            <span class="material-icons text-xl">local_hospital</span><span class="text-[10px] font-bold uppercase">Doctor</span>
        </a>

    </div>
  </nav>

<script>
    // --- VISUALS ONLY ---
    // Note: The logic for getSeasonalForecast() is now 100% inside /static/js/app.js
    
    // --- 1. THREE.JS BACKGROUND ---
    const initThreeJS = () => {
        const container = document.getElementById('canvas-container');
        if (!container) return;
        
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.035); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 8;
        camera.position.y = 2;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // Terrain
        const geoPlane = new THREE.PlaneGeometry(120, 120, 50, 50);
        const pos = geoPlane.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            const x = pos.getX(i);
            const y = pos.getY(i);
            pos.setZ(i, Math.sin(x/10) * Math.cos(y/10) * 2.5 + Math.random() * 0.1);
        }
        geoPlane.computeVertexNormals();
        
        const matPlane = new THREE.MeshStandardMaterial({ 
            color: 0x022c22, emissive: 0x065f46, emissiveIntensity: 0.15, wireframe: true, transparent: true, opacity: 0.12
        });
        const terrain = new THREE.Mesh(geoPlane, matPlane);
        terrain.rotation.x = -Math.PI / 2.1;
        terrain.position.y = -3;
        scene.add(terrain);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x10b981, 2, 60); 
        pointLight.position.set(0, 5, 5);
        scene.add(pointLight);

        let time = 0;
        const animate = () => {
            requestAnimationFrame(animate);
            time += 0.003;
            terrain.position.z = (Date.now() * 0.001) % 4; 
            renderer.render(scene, camera);
        };
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    };

    // --- 2. CHART LOGIC ---
    function renderHourlyChart(hourlyData) {
      if (typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); }
      
      const pointWidth = 100; 
      const totalWidth = Math.max(hourlyData.length * pointWidth, 1200);
      const container = document.getElementById("chartContainer");
      if(container) container.style.width = `${totalWidth}px`;
      
      const labels = hourlyData.map(d => [d.time, d.condition]);
      const temps = hourlyData.map(d => d.temp);
      const rainProb = hourlyData.map(d => d.rain_prob);
      const minTemp = Math.min(...temps) - 5;
      const maxTemp = Math.max(...temps) + 5;

      const canvas = document.getElementById("hourlyChart");
      if(!canvas) return;
      
      const ctxMain = canvas.getContext("2d");
      if (window.hourlyChartRef instanceof Chart) window.hourlyChartRef.destroy();
      
      const tempGradient = ctxMain.createLinearGradient(0, 0, 0, 400);
      tempGradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); 
      tempGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

      Chart.defaults.font.family = "'Space Grotesk', sans-serif";
      Chart.defaults.color = "#9ca3af";

      window.hourlyChartRef = new Chart(ctxMain, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { 
              label: 'Temp',
              type: 'line', 
              data: temps, 
              borderColor: '#10b981', 
              backgroundColor: tempGradient,
              fill: true,
              borderWidth: 2, 
              tension: 0.4, 
              pointRadius: 4,
              pointBackgroundColor: '#064e3b',
              pointBorderColor: '#34d399',
              yAxisID: 'yTemp',
              datalabels: { 
                align: 'top', anchor: 'end', color: '#fff', font: { weight: 'bold', size: 14 }, formatter: (val) => Math.round(val) + '°' 
              } 
            },
            { 
              label: 'Rain %',
              type: 'bar', 
              data: rainProb, 
              backgroundColor: 'rgba(56, 189, 248, 0.3)',
              hoverBackgroundColor: 'rgba(56, 189, 248, 0.6)',
              barThickness: 40,
              borderRadius: 4,
              yAxisID: 'yRain', 
              datalabels: { 
                  color: '#7dd3fc', anchor: 'end', align: 'top', font: { size: 10, weight: 'bold' }, formatter: (val) => val > 0 ? val + '%' : ''
              } 
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          animation: { duration: 1500, easing: 'easeOutQuart' },
          layout: { padding: { top: 30, bottom: 10 } },
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: { 
            x: { grid: { display: true, color: 'rgba(255, 255, 255, 0.05)', borderDash: [4, 4] }, ticks: { color: '#9ca3af', font: { size: 11 } } }, 
            yTemp: { display: false, min: minTemp, max: maxTemp }, 
            yRain: { display: false, min: 0, max: 100 } 
          }
        }
      });
    }

    function getWeatherIconUrl(code) { return `https://openweathermap.org/img/wn/${code}@2x.png`; }
    
    // --- 3. LIST RENDERING ---
    function renderDailyList(dailyData) {
      const container = document.getElementById("dailyForecastList");
      if(!container) return;
      container.innerHTML = "";
      dailyData.forEach((day, index) => {
        const iconUrl = getWeatherIconUrl(day.icon);
        const card = document.createElement("div");
        card.className = "glass-panel rounded-xl overflow-hidden transition-all duration-300 mb-2 border border-white/5 hover:border-emerald-500/30";
        card.innerHTML = `
          <div class="p-4 flex items-center justify-between cursor-pointer group" onclick="toggleDetails('details-${index}', this)">
            <div class="flex items-center gap-4">
               <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">
                 <img src="${iconUrl}" alt="${day.description}" class="w-8 h-8 opacity-80 group-hover:opacity-100 transition-opacity">
               </div>
               <div>
                   <p class="font-bold text-white tracking-wide">${day.date}</p>
                   <p class="text-xs text-gray-400 capitalize font-mono">${day.description}</p>
               </div>
            </div>
            <div class="flex items-center gap-6">
               <div class="text-right">
                   <span class="font-bold text-lg text-emerald-400">${Math.round(day.temp_max)}°</span> 
                   <span class="text-gray-600 text-sm">/ ${Math.round(day.temp_min)}°</span>
               </div>
               <span class="material-icons text-gray-500 rotate-icon group-hover:text-emerald-500">expand_more</span>
            </div>
          </div>
          <div id="details-${index}" class="details-content">
             <div class="p-4 border-t border-white/5 grid grid-cols-2 sm:grid-cols-4 gap-4 text-xs font-mono tracking-wide">
                <div class="flex flex-col items-center p-2 bg-white/5 rounded-lg">
                    <span class="material-icons text-cyan-400 mb-1 text-base">water_drop</span>
                    <span class="text-gray-400">Precip</span>
                    <span class="font-bold text-white">${day.rain_total} mm</span>
                </div>
                <div class="flex flex-col items-center p-2 bg-white/5 rounded-lg">
                    <span class="material-icons text-gray-400 mb-1 text-base">air</span>
                    <span class="text-gray-400">Wind</span>
                    <span class="font-bold text-white">${day.wind} m/s</span>
                </div>
                <div class="flex flex-col items-center p-2 bg-white/5 rounded-lg">
                    <span class="material-icons text-blue-400 mb-1 text-base">thermostat</span>
                    <span class="text-gray-400">Humidity</span>
                    <span class="font-bold text-white">${day.humidity}%</span>
                </div>
                <div class="flex flex-col items-center p-2 bg-white/5 rounded-lg">
                    <span class="material-icons text-purple-400 mb-1 text-base">speed</span>
                    <span class="text-gray-400">Pressure</span>
                    <span class="font-bold text-white">${day.pressure} hPa</span>
                </div>
             </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function toggleDetails(contentId, headerEl) {
       const content = document.getElementById(contentId);
       const isOpen = content.classList.contains('open');
       document.querySelectorAll('.details-content.open').forEach(el => el.classList.remove('open'));
       document.querySelectorAll('.rotate-icon').forEach(el => { el.style.transform = 'rotate(0deg)'; el.style.color = '#6b7280'; });
       if (!isOpen) { 
         content.classList.add('open');
         const icon = headerEl.querySelector('.rotate-icon');
         icon.style.transform = 'rotate(180deg)';
         icon.style.color = '#10b981';
       }
    }

    async function loadForecast() {
      try {
        const res = await fetch(`/forecast`);
        const data = await res.json();
        if (!data || !data.daily) return;
        renderHourlyChart(data.hourly);
        renderDailyList(data.daily);
      } catch (err) { console.error(err); }
    }

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        initThreeJS();
        if(window.VanillaTilt) VanillaTilt.init(document.querySelectorAll("[data-tilt]"), { max: 3, speed: 400, glare: true, "max-glare": 0.1 });
        
        loadForecast(); 
        
        // MEMORY RESTORE: GEM 1 (Predict)
        // Handled by app.js, but we ensure defaults here if memory is empty
        const dateInput = document.getElementById('forecastDate');
        if(dateInput && !dateInput.value) dateInput.valueAsDate = new Date();
    });
  </script>