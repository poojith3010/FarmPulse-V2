# FarmPulse - Software Documentation 

**FarmPulse** is an AI-driven smart agriculture platform designed to automate farm monitoring and decision-making. It enables farmers to track real-time soil health (NPK, moisture), monitor hyper-local weather conditions, and manage field devices through a secure, responsive web dashboard.

---

## Key Features

* **Real-time Dashboard:** Live visualization of sensor data (Temperature, Humidity, Soil Moisture, NPK, pH).
* **Secure Authentication:** User signup/login system powered by Supabase Auth with "Smart Login" redirection.
* **Device Management:** Secure claiming system allowing users to link ESP32 hardware using unique MAC Keys.
* **Weather Forecasting:** Integrated 48-hour and 5-day weather forecasts using OpenWeatherMap API.
* **Automated Mapping:** Intelligent backend logic that automatically links incoming sensor data to the correct user profile.
* **AI Integration:** (Optional) Ready-to-use infrastructure for crop prediction and chatbot advisory.

---

## Tech Stack

### **Backend**
* **Language:** Python 3.9+
* **Framework:** FastAPI
* **Server:** Uvicorn (ASGI)
* **Database Client:** Supabase-Python

### **Frontend**
* **Core:** HTML5, Vanilla JavaScript (ES6+)
* **Styling:** Tailwind CSS (via CDN)
* **Icons:** Google Material Icons
* **State Management:** LocalStorage & Supabase Client

### **Database & Cloud**
* **Platform:** Supabase (PostgreSQL)
* **Auth:** Supabase Auth (Email/Password)
* **Security:** Row Level Security (RLS) & Service Role access.

---

## Installation & Setup

### 1. Clone the Repository
```
git clone [https://github.com/yourusername/farmpulse-software.git](https://github.com/yourusername/farmpulse-software.git)
cd farmpulse-software
```

### 2. Backend Environment Setup
It is recommended to use a virtual environment.

```
# Create virtual environment
python -m venv venv

# Activate it
# Windows:
venv\Scripts\activate
# Mac/Linux:
source venv/bin/activate

# Install dependencies
pip install fastapi uvicorn supabase python-dotenv requests pydantic
```

### 3. Configuration (.env)
Create a .env file in the root directory. You need two keys:
Service Role Key: For the Python Backend (bypasses RLS).
Anon Key: For the Frontend (respects RLS).

```
# .env file
SUPABASE_URL="[https://your-project-id.supabase.co](https://your-project-id.supabase.co)"
SUPABASE_KEY="your_service_role_key_here"  # <--- MUST BE SERVICE ROLE KEY
WEATHER_API_KEY="your_openweathermap_api_key"
```

### 4. Database Setup (SQL)
Run the following SQL queries in your Supabase SQL Editor to set up the schema and automation triggers.

```
-- Profile Table (Links Auth Users to Data)
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT,
  mac_address TEXT,
  created_at TIMESTAMP DEFAULT now()
);

-- Sensor Data Table
CREATE TABLE public.sensor_data (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP DEFAULT now(),
  mac_address TEXT,
  user_id UUID REFERENCES auth.users(id), -- Auto-filled by trigger
  temperature FLOAT,
  humidity FLOAT,
  soil_moisture FLOAT,
  ph_value FLOAT,
  nitrogen FLOAT,
  phosphorus FLOAT,
  potassium FLOAT
);

-- Device Registry (For Hardware Linking)
CREATE TABLE public.device_registry (
  mac_address TEXT PRIMARY KEY,
  mac_key TEXT NOT NULL,
  status_indicator INT DEFAULT 0, -- 0=Inactive, 1=Active
  last_seen TIMESTAMP DEFAULT now()
);
```

### B. Triggers (The Magic Automation)
These triggers ensure data is always mapped correctly, even if the backend misses a step.

```
-- Trigger 1: Auto-create Profile on Signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email)
  VALUES (new.id, new.email);
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Trigger 2: Auto-Map Sensor Data to User
CREATE OR REPLACE FUNCTION public.link_user_to_sensor_data()
RETURNS TRIGGER AS $$
DECLARE
    owner_id UUID;
BEGIN
    SELECT id INTO owner_id FROM public.profiles WHERE mac_address = NEW.mac_address;
    IF owner_id IS NOT NULL THEN
        NEW.user_id := owner_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_sensor_data_insert
BEFORE INSERT ON public.sensor_data
FOR EACH ROW EXECUTE FUNCTION public.link_user_to_sensor_data();
```

### 5. Frontend Configuration
Open static/js/app.js and update your public keys:

```
var SUPABASE_URL = "[https://your-project-id.supabase.co](https://your-project-id.supabase.co)";
var SUPABASE_KEY = "your_anon_key_here"; // <--- MUST BE PUBLIC ANON KEY
```
---

## Running the Application
**Start the Backend Server:**
```
uvicorn main:app --reload
```
**Access the App:** Open your browser and go to http://127.0.0.1:8000/.
---

## Project Structure
```
farmpulse/
│
├── main.py                # FastAPI Backend Application
├── .env                   # Environment Variables (Secrets)
├── requirements.txt       # Python Dependencies
│
├── static/                # Frontend Assets
│   ├── css/
│   │   └── style.css      # Custom Styles
│   ├── js/
│   │   └── app.js         # Global Auth & Supabase Logic
│   ├── images/            # Project Images
│   │
│   ├── login.html         # Entry Point
│   ├── signup.html        # Registration
│   ├── dashboard.html     # Main User Interface
│   ├── setup_hardware.html# Device Linking Page
│   └── prediction.html    # AI/ML Features
│
└── README.md              # Project Documentation
```
---
## API Endpoints
| Method | Endpoint | Description |
| :--- | :--- | :--- |
| **POST** | `/api/register-device` | ESP32 registers itself (Status 0). |
| **POST** | `/api/verify-device-key` | User claims a device using the Secret Key. |
| **POST** | `/api/hardware-log` | Receives sensor data from ESP32. |
| **GET** | `/weather` | Fetches current weather for farm location. |
| **GET** | `/forecast` | Fetches 5-day forecast data. |
---

## Security Notes

* **RLS (Row Level Security):** Enabled on Supabase tables to prevent users from seeing each other's data.
* **Service Role:** The Python backend uses the Service Role key to perform admin tasks (like finding which user owns a device) that regular users cannot do.
* **Crash-Proof JS:** The frontend uses robust variable checking (var supabaseClient) to prevent browser console errors during navigation.
---
**FarmPulse Software**